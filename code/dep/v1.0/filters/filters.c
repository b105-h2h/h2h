/*
 * filters.c
 *
 *  Created on: 15/12/2015
 *      Author: tvalno
 */

#include "filters.h"

#define INTEGRATION_LENGTH 16
#define BP_ORDER 253
//#define H_ORDER 311
#define L_ORDER 50
#define DIF_ORDER 32

//// FIR BPF 1-40 hz (500 SPS / ORDER 579)
//const int32_t band_pass_coef[BP_ORDER] = {-5, 13, 1, -3, -4, -5, -5, -5, -5, -5, -4, -3, -2, -1, 0, 0, 0, 0, -1, -1, -2, -2,
//		-2, -1, -1, 0, 0, 0, 0, 0, -1, -1, -2, -2, -2, -1, -1, 0, 0, 0, 0, 0, -1, -1, -2, -2, -2, -1, -1, -1, 0, 0, 0, 0, -1,
//		-1, -2, -2, -2, -2, -1, -1, 0, 0, 0, 0, -1, -1, -2, -2, -2, -2, -2, -1, -1, 0, 0, 0, -1, -1, -2, -2, -2, -2, -2, -1,
//		-1, 0, 0, 0, 0, -1, -2, -2, -3, -3, -2, -2, -1, 0, 0, 0, 0, -1, -2, -2, -3, -3, -3, -2, -1, -1, 0, 0, 0, -1, -1, -2,
//		-3, -3, -3, -2, -2, -1, 0, 0, 0, 0, -1, -2, -3, -3, -3, -3, -2, -1, 0, 0, 0, 0, -1, -2, -3, -3, -4, -3, -3, -2, -1, 0,
//		0, 0, -1, -2, -3, -4, -4, -4, -3, -2, -1, 0, 0, 0, 0, -1, -3, -4, -4, -4, -4, -3, -1, 0, 1, 1, 0, -1, -2, -4, -4, -5,
//		-4, -3, -2, -1, 1, 1, 1, 0, -2, -3, -5, -5, -5, -4, -3, -1, 0, 1, 1, 0, -1, -3, -5, -6, -6, -5, -3, -2, 0, 2, 2, 1, 0,
//		-2, -5, -6, -7, -6, -5, -2, 0, 2, 3, 2, 1, -2, -4, -6, -8, -7, -6, -3, 0, 2, 4, 4, 2, 0, -4, -7, -9, -9, -8, -5, -1, 2,
//		5, 6, 5, 2, -3, -7, -10, -12, -11, -8, -3, 2, 7, 9, 9, 5, 0, -7, -13, -17, -17, -13, -6, 3, 11, 17, 19, 15, 6, -7, -21,
//		-33, -38, -35, -21, 3, 34, 71, 106, 136, 156, 163, 156, 136, 106, 71, 34, 3, -21, -35, -38, -33, -21, -7, 6, 15, 19, 17,
//		11, 3, -6, -13, -17, -17, -13, -7, 0, 5, 9, 9, 7, 2, -3, -8, -11, -12, -10, -7, -3, 2, 5, 6, 5, 2, -1, -5, -8, -9, -9,
//		-7, -4, 0, 2, 4, 4, 2, 0, -3, -6, -7, -8, -6, -4, -2, 1, 2, 3, 2, 0, -2, -5, -6, -7, -6, -5, -2, 0, 1, 2, 2, 0, -2, -3,
//		-5, -6, -6, -5, -3, -1, 0, 1, 1, 0, -1, -3, -4, -5, -5, -5, -3, -2, 0, 1, 1, 1, -1, -2, -3, -4, -5, -4, -4, -2, -1, 0, 1,
//		1, 0, -1, -3, -4, -4, -4, -4, -3, -1, 0, 0, 0, 0, -1, -2, -3, -4, -4, -4, -3, -2, -1, 0, 0, 0, -1, -2, -3, -3, -4, -3, -3,
//		-2, -1, 0, 0, 0, 0, -1, -2, -3, -3, -3, -3, -2, -1, 0, 0, 0, 0, -1, -2, -2, -3, -3, -3, -2, -1, -1, 0, 0, 0, -1, -1, -2,
//		-3, -3, -3, -2, -2, -1, 0, 0, 0, 0, -1, -2, -2, -3, -3, -2, -2, -1, 0, 0, 0, 0, -1, -1, -2, -2, -2, -2, -2, -1, -1, 0, 0,
//		0, -1, -1, -2, -2, -2, -2, -2, -1, -1, 0, 0, 0, 0, -1, -1, -2, -2, -2, -2, -1, -1, 0, 0, 0, 0, -1, -1, -1, -2, -2, -2, -1,
//		-1, 0, 0, 0, 0, 0, -1, -1, -2, -2, -2, -1, -1, 0, 0, 0, 0, 0, -1, -1, -2, -2, -2, -1, -1, 0, 0, 0, 0, -1, -2, -3, -4, -5,
//		-5, -5, -5, -5, -4, -3, 1, 13, -5
};

//// FIR DIF (500 SPS)
//const int32_t diferentiator_coef[DIF_ORDER] = {-4, 6, -3, 3, -3, 3, -4, 5, -6, 8, -11, 16, -27, 52, -145, 1304, -1304, 145,
//												-52, 27, -16, 11, -8, 6, -5, 4, -3, 3, -3, 3, -6, 4};

// FIR BPF 1-40 hz (250 SPS / ORDER 362)
const int32_t band_pass_coef[BP_ORDER] = { -8, -11, -9, -8, -2, 1, 3, 0, -2, -4, -2, -1, 1, 0, -2, -3, -2, -1, 0, 0, -2, -3, -2, -1, 0,
		0, -2, -3, -3, -2, 0, 0, -2, -3, -3, -2, -1, 0, -1, -3, -3, -2, -1, 0, -1, -3, -4, -3, -1, 0, -1, -3, -4, -3, -2, 0, -1, -3, -4,
		-4, -2, 0, -1, -2, -4, -4, -2, -1, 0, -2, -4, -5, -3, -1, 0, -2, -4, -5, -4, -1, 0, -1, -4, -5, -4, -2, 0, -1, -4, -6, -5, -2, 0,
		0, -3, -6, -6, -3, 0, 0, -3, -6, -6, -4, 0, 1, -2, -6, -7, -5, -1, 1, -1, -6, -8, -6, -1, 1, 0, -5, -8, -7, -2, 2, 1, -4, -9, -8,
		-3, 2, 2, -3, -9, -9, -4, 2, 3, -2, -9, -11, -6, 2, 4, 0, -9, -13, -8, 1, 6, 2, -8, -14, -11, 0, 8, 5, -7, -17, -15, -1, 11, 10,
		-5, -20, -21, -5, 15, 18, 0, -26, -33, -11, 23, 38, 12, -42, -75, -41, 70, 213, 313, 313, 213, 70, -41, -75, -42, 12, 38, 23, -11,
		-33, -26, 0, 18, 15, -5, -21, -20, -5, 10, 11, -1, -15, -17, -7, 5, 8, 0, -11, -14, -8, 2, 6, 1, -8, -13, -9, 0, 4, 2, -6, -11, -9,
		-2, 3, 2, -4, -9, -9, -3, 2, 2, -3, -8, -9, -4, 1, 2, -2, -7, -8, -5, 0, 1, -1, -6, -8, -6, -1, 1, -1, -5, -7, -6, -2, 1, 0, -4, -6,
		-6, -3, 0, 0, -3, -6, -6, -3, 0, 0, -2, -5, -6, -4, -1, 0, -2, -4, -5, -4, -1, 0, -1, -4, -5, -4, -2, 0, -1, -3, -5, -4, -2, 0, -1,
		-2, -4, -4, -2, -1, 0, -2, -4, -4, -3, -1, 0, -2, -3, -4, -3, -1, 0, -1, -3, -4, -3, -1, 0, -1, -2, -3, -3, -1, 0, -1, -2, -3, -3,
		-2, 0, 0, -2, -3, -3, -2, 0, 0, -1, -2, -3, -2, 0, 0, -1, -2, -3, -2, 0, 1, -1, -2, -4, -2, 0, 3, 1, -2, -8, -9, -11, -8
};

// FIR DIF (500 SPS)
const int32_t diferentiator_coef[DIF_ORDER] = {-4, 6, -3, 3, -3, 3, -4, 5, -6, 8, -11, 16, -27, 52, -145, 1304 };//, -1304, 145,-52, 27, -16, 11, -8, 6, -5, 4, -3, 3, -3, 3, -6, 4};


int32_t band_pass_filterino(int32_t value)
{
	static int32_t bp_buffer[(BP_ORDER - 1)] = {0}, aux = 0;
	int i;
	int32_t y_n = 0;

	for(i = (BP_ORDER - 2) ; i > 0; i-- ){
		aux = (band_pass_coef[i + 1] * bp_buffer[i]);
		if ((aux < -1024)||(aux > 0))
		{
			y_n += (aux >> 10);
		}
        bp_buffer[i] = bp_buffer[i-1];
	}

	aux = (band_pass_coef[1] * bp_buffer[0]);
	if ((aux < -1024)||(aux > 0))
	{
		y_n += (aux >> 10);
	}

    bp_buffer[0] = value;

	aux = (band_pass_coef[0] * value);
	if ((aux < -1024)||(aux > 0))
	{
		y_n += (aux >> 10);
	}

    return y_n;
}

//int32_t diferentiator_3000(int32_t value)
//{
//	static int32_t dif_buffer[(DIF_ORDER - 1)];
//	int i;
//	int32_t y_n = 0;
//
//	for(i = (DIF_ORDER - 2); i > 0; i-- ){
//        y_n += ((diferentiator_coef[i + 1] * dif_buffer[i]) >> 10);
//        dif_buffer[i] = dif_buffer[i-1];
//	}
//
//    y_n += ((diferentiator_coef[1] * dif_buffer[0]) >> 10);
//    dif_buffer[0] = value;
//
//    y_n += ((diferentiator_coef[0] * value) >> 10);
//
//    return y_n;
//}
// FOLDED VERSION
int32_t diferentiator_3000(int32_t value)
{
	static int32_t dif_buffer[(DIF_ORDER - 1)];
	int i;
	int32_t y_n = 0;

	for(i = (DIF_ORDER - 2); i > 0; i-- ){
        y_n += ((diferentiator_coef[i + 1] * dif_buffer[i]) >> 10);
        dif_buffer[i] = dif_buffer[i-1];
	}

    y_n += ((diferentiator_coef[1] * dif_buffer[0]) >> 10);
    dif_buffer[0] = value;

    y_n += ((diferentiator_coef[0] * value) >> 10);

    return y_n;
}

int32_t integrator_3000(int32_t value)
{
	static int32_t buffer_x[INTEGRATION_LENGTH];
	int32_t x_n = value, y_n = 0;
	uint8_t i;

    for ( i = INTEGRATION_LENGTH - 1; i > 0; i--)
    {
    	y_n += (buffer_x[i] / INTEGRATION_LENGTH);
		buffer_x[i] = buffer_x[i-1];
    }

    y_n += (buffer_x[0] / INTEGRATION_LENGTH);
    buffer_x[0] = x_n;

	return y_n;
}

int32_t filter_sample(int32_t value)
{
	int32_t filtered_value = value;


//	filtered_value = band_pass_filterino(filtered_value);

	filtered_value = diferentiator_3000(filtered_value);

	filtered_value = (filtered_value >> 2) * (filtered_value >> 2);

	filtered_value = integrator_3000(filtered_value);

	return filtered_value;											//Return true
}
